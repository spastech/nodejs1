var njwt = require('njwt');

var stormpath = require('stormpath');

var client = new stormpath.Client();

var appHref = 'https://staging-api-b.stormpath.com/v1/applications/24k7HnDOz4tQ9ARsBtPUN6';


client.getApplication(appHref, function(err, application) {

  var passwordAuthenticator = new stormpath.OAuthPasswordGrantRequestAuthenticator(application);

  var jwtAuthenticator = new stormpath.JwtAuthenticator(application);

  var authenticationRequest = {
    username: 'robert@stormpath.com',
    password: 'robert@stormpath.comA1'
  };

  passwordAuthenticator.authenticate(authenticationRequest, function(err, oAuthPasswordGrantAuthenticationResult) {

    var newToken = njwt.create(oAuthPasswordGrantAuthenticationResult.accessToken.body, process.env.STORMPATH_CLIENT_APIKEY_SECRET);

    newToken.header.typ = oAuthPasswordGrantAuthenticationResult.accessToken.header.typ;
    newToken.header.alg = oAuthPasswordGrantAuthenticationResult.accessToken.header.alg;
    newToken.header.kid = oAuthPasswordGrantAuthenticationResult.accessToken.header.kid;
    newToken.header.stt = oAuthPasswordGrantAuthenticationResult.accessToken.header.stt;
    newToken.body.scope = 'foo';

    console.log(err, oAuthPasswordGrantAuthenticationResult.accessToken.body);

    console.log(newToken.body);
    debugger
    jwtAuthenticator.authenticate(newToken.compact(), function (err, authenticationResult) {
      console.log(err, authenticationResult.expandedJwt.claims);
    });

    // var newToken =
  });
});